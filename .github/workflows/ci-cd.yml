name: CI/CD – Shopping Site (Matrix)

on:
  push:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  IMAGE_TAG: ${{ github.sha }}

permissions:
  contents: read

jobs:
# =========================
# CI – Build & Push Images
# =========================
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service: 
          - name: main
            path: frontend/main
          - name: electronics
            path: frontend/electronics
          - name: phones
            path: frontend/phones
          - name: computers
            path: frontend/computers
          - name: earphones
            path: frontend/earphones
          - name: googlemusic
            path: frontend/googlemusic
          - name: googlepay
            path: frontend/googlepay
          - name: googleclothes
            path: frontend/googleclothes
          - name: googlegrocery
            path: frontend/googlegrocery
          - name: backend
            path: backend

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push Image
        run: |
          set -e

          if [ "${{ matrix.service.name }}" = "backend" ]; then
            REPO="shopping-site-backend"
          else
            REPO="shopping-site-${{ matrix.service.name }}"
          fi

          IMAGE="$ECR_REGISTRY/$REPO:$IMAGE_TAG"

          echo "Building $REPO from ${{ matrix.service.path }}"

          aws ecr describe-repositories --repository-names $REPO >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name $REPO

          docker build -t $IMAGE ${{ matrix.service.path }}
          docker push $IMAGE

          docker tag $IMAGE $ECR_REGISTRY/$REPO:latest
          docker push $ECR_REGISTRY/$REPO:latest
  deploy:
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --region us-east-1 --name google

      - name: Deploy Backend
        run: |
          kubectl set image deployment/backend-deployment \
            backend-container=$ECR_REGISTRY/shopping-site-backend:$IMAGE_TAG

      - name: Deploy Frontend
        run: |
          for svc in main electronics phones computers earphones googlemusic googlepay googleclothes googlegrocery; do
            kubectl set image deployment/frontend-$svc \
              frontend-container=$ECR_REGISTRY/shopping-site-$svc:$IMAGE_TAG
          done
